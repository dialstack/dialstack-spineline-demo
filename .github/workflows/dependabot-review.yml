# Dependabot Claude Review
#
# SECURITY MODEL:
# - Uses pull_request_target for PR approval permissions
# - ONLY runs for dependabot[bot] PRs (trusted automation)
# - Checks out BASE BRANCH (not PR code) to avoid executing untrusted dependencies
# - Claude uses GitHub API to read PR diff, never executes PR code
# - No npm install, npm test, or other code execution occurs
#
# See: https://docs.github.com/en/actions/security-for-github-actions/security-guides/security-hardening-for-github-actions#understanding-the-risk-of-script-injections
name: Dependabot Claude review
on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  id-token: write
  checks: read

jobs:
  metadata:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    outputs:
      update-type: ${{ steps.metadata.outputs.update-type }}
      dependency-names: ${{ steps.metadata.outputs.dependency-names }}
      previous-version: ${{ steps.metadata.outputs.previous-version }}
      new-version: ${{ steps.metadata.outputs.new-version }}
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

  review:
    needs: metadata
    runs-on: ubuntu-latest
    if: needs.metadata.outputs.update-type != 'version-update:semver-patch'
    steps:
      # SECURITY: Explicitly checkout base branch, NOT the PR head.
      # This ensures we never execute code from the PR (e.g., malicious postinstall scripts).
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      # Uses OIDC to assume github-claude role with minimal Bedrock permissions.
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_BEDROCK_ROLE_ARN }}
          aws-region: us-east-1

      - name: Claude review and auto-approve
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_bedrock: "true"
          prompt: |
            Review this Dependabot dependency update:

            - Dependency: ${{ needs.metadata.outputs.dependency-names }}
            - Update type: ${{ needs.metadata.outputs.update-type }}
            - From: ${{ needs.metadata.outputs.previous-version }}
            - To: ${{ needs.metadata.outputs.new-version }}

            Please:
            1. Check CI status with `gh pr checks` - do NOT approve if checks are failing or pending
            2. Fetch and review the changelog for breaking changes
            3. Check if any code in this repo uses deprecated APIs
            4. Assess risk level (low/medium/high)

            Decision rules:
            - MINOR updates with ALL CHECKS PASSING, NO breaking changes, and LOW risk: approve the PR with `gh pr review --approve` and enable auto-merge with `gh pr merge --auto --merge`
            - MINOR updates with failing checks, breaking changes, OR medium risk: comment with findings, do NOT approve
            - MAJOR updates: always comment with detailed analysis, do NOT approve (human review required)

            Always leave a comment explaining your analysis including the CI status.
